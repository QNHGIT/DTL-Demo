{
  "$schema": "https://raw.githubusercontent.com/Azure/azure-devtestlab/master/schemas/2016-11-28/dtlArtifacts.json",
  "title": "Join Active Directory (AD) domain",
  "description": "Joins the virtual machine to the given Active Directory domain and reboots the machine.",
  "publisher": "Microsoft",
  "tags": [
    "Windows"
  ],
  "iconUri": "https://raw.githubusercontent.com/Azure/azure-devtestlab/master/Artifacts/windows-domain-join/domainJoinArtifact.png",
  "targetOsType": "Windows",
  "parameters": {
    "domainAdminUsername": {
      "value": "testry.local\\srvradmin"
    },
    "domainAdminPassword": {
      "reference": {
        "keyVault": {
          "id": "/subscriptions/05b9e932-1e04-4487-95fd-726ea5ade0f4/resourceGroups/QNH-RG-LAB-WE-RY2/providers/Microsoft.KeyVault/vaults/bigkeyvault"
        },
        "secretName": "srvradmin"
      }
    },
    "domainToJoin": {
      "type": "string",
      "displayName": "Active Directory domain name",
      "description": "The name of the Active Directory (AD) domain to join (e.g. devtest.lab)."
    },
    "ouPath": {
      "type": "string",
      "displayName": "Active Directory (AD) domain OU",
      "description": "The OU path e.g. OU=DEV,OU=Computers,OU=DEVTEST,DC=devtest,DC=lab or OU=TST,OU=Computers,OU=DEVTEST,DC=devtest,DC=lab"
    }
  },
  "runCommand": {
    "commandToExecute": "[concat('powershell.exe -ExecutionPolicy bypass \"& ./artifact-main.ps1', ' -domainAdminUsername ', parameters('domainAdminUsername'), ' -domainAdminPassword ''', parameters('domainAdminPassword'), ''' -domainToJoin ', parameters('domainToJoin'), ' -ouPath ''', parameters('ouPath'), '''\"')]"
  },
  "postDeployActions": [
    {
      "action": "restart"
    }
  ]
}
